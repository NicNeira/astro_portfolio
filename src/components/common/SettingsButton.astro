---
import { Icon } from "astro-icon/components";
import { languages, getLangFromUrl, useTranslations } from "@utils/i18n";

const currentLang = getLangFromUrl(Astro.url);
const currentPath = Astro.url.pathname;
const t = useTranslations(currentLang);

// ID único por instancia para accesibilidad sin colisiones en DOM
const uid = Math.random().toString(36).slice(2, 8);
const buttonId = `settings-menu-${uid}`;
const dropdownId = `settings-dropdown-${uid}`;

// Función para generar URLs de idiomas
function getLocalizedPath(lang: string, currentPath: string) {
  const pathSegments = currentPath.split("/").filter(Boolean);

  // Si la primera parte es un código de idioma, reemplazarla
  if (pathSegments[0] && pathSegments[0] in languages) {
    pathSegments[0] = lang;
  } else if (lang !== "es") {
    // Si no hay idioma en la URL y no es español, agregar el idioma
    pathSegments.unshift(lang);
  }

  // Para español, no agregar prefijo
  if (lang === "es") {
    return (
      "/" + pathSegments.filter((segment) => !(segment in languages)).join("/")
    );
  }

  return "/" + pathSegments.join("/");
}

// Función para obtener la bandera del idioma actual
function getFlagEmoji(lang: string) {
  switch (lang) {
    case "es":
      return "🇪🇸";
    case "en":
      return "🇺🇸";
    case "de":
      return "🇩🇪";
    default:
      return "🌐";
  }
}
---

<div class="relative inline-block text-left" data-settings-root>
  <div>
    <button
      type="button"
      class="settings-toggle-button inline-flex items-center justify-center w-10 h-10 rounded-lg text-gray-600 dark:text-gray-400 hover:cursor-pointer focus:outline-none transition-all duration-200"
      id={buttonId}
      aria-expanded="false"
      aria-haspopup="true"
      aria-label={t("settings.menu")}
      aria-controls={dropdownId}
    >
      <Icon name="tabler:settings" class="w-5 h-5" />
    </button>
  </div>

  <div
    class="settings-dropdown origin-top-right absolute right-0 mt-2 w-48 rounded-lg shadow-xl bg-white dark:bg-gray-800 ring-1 ring-gray-200 dark:ring-gray-700 focus:outline-none hidden"
    id={dropdownId}
    role="menu"
    aria-orientation="vertical"
    aria-labelledby={buttonId}
    tabindex="-1"
  >
    <div class="py-2" role="none">
      <!-- Sección de Tema -->
      <div class="px-4 py-2 border-b border-gray-200 dark:border-gray-700">
        <div class="flex items-center justify-between">
          <span class="text-sm font-medium text-gray-700 dark:text-gray-200"
            >{t("settings.theme")}</span
          >
          <button
            type="button"
            class="theme-toggle-button inline-flex items-center justify-center w-8 h-8 rounded-md bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 hover:cursor-pointer transition-colors duration-200"
            aria-label={t("settings.change-theme")}
          >
            <Icon name="tabler:sun" class="w-4 h-4 dark:hidden" />
            <Icon
              name="tabler:moon"
              class="w-4 h-4 hidden dark:inline-block dark:text-white"
            />
          </button>
        </div>
      </div>

      <!-- Sección de Idioma -->
      <div class="px-4 py-2">
        <span
          class="text-sm font-medium text-gray-700 dark:text-gray-200 block mb-2"
          >{t("settings.language")}</span
        >
        <div class="space-y-1">
          {
            Object.entries(languages).map(([lang, name]) => (
              <a
                href={getLocalizedPath(lang, currentPath)}
                class={`${
                  currentLang === lang
                    ? "bg-indigo-50 dark:bg-indigo-900/20 text-indigo-700 dark:text-indigo-300"
                    : "text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700"
                } group flex items-center px-3 py-2 text-sm rounded-md transition-colors duration-200 cursor-pointer`}
                role="menuitem"
                tabindex="-1"
              >
                <span class="text-lg mr-3">{getFlagEmoji(lang)}</span>
                <span class="flex-1">{name}</span>
                {currentLang === lang && (
                  <Icon
                    name="tabler:check"
                    class="w-4 h-4 text-indigo-600 dark:text-indigo-400"
                  />
                )}
              </a>
            ))
          }
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // Tema
  function applyTheme(theme: string): void {
    if (theme === "dark") {
      document.documentElement.classList.add("dark");
      localStorage.setItem("theme", "dark");
    } else {
      document.documentElement.classList.remove("dark");
      localStorage.setItem("theme", "light");
    }
  }

  function closeDropdown(container: HTMLElement): void {
    const btn = container.querySelector(
      ".settings-toggle-button"
    ) as HTMLButtonElement | null;
    const dd = container.querySelector(
      ".settings-dropdown"
    ) as HTMLElement | null;
    if (dd && !dd.classList.contains("hidden")) {
      dd.classList.add("hidden");
      btn?.setAttribute("aria-expanded", "false");
    }
  }

  function openDropdown(container: HTMLElement): void {
    const btn = container.querySelector(
      ".settings-toggle-button"
    ) as HTMLButtonElement | null;
    const dd = container.querySelector(
      ".settings-dropdown"
    ) as HTMLElement | null;
    if (dd && dd.classList.contains("hidden")) {
      // Cerrar otros abiertos antes de abrir este
      document
        .querySelectorAll(
          "[data-settings-root] .settings-dropdown:not(.hidden)"
        )
        .forEach((other: Element) => {
          const c = (other as HTMLElement).closest("[data-settings-root]");
          if (c && c !== container) closeDropdown(c as HTMLElement);
        });

      dd.classList.remove("hidden");
      btn?.setAttribute("aria-expanded", "true");
    }
  }

  function initOne(container: HTMLElement): void {
    if ((container as HTMLElement).dataset.initialized === "true") return;

    const settingsButton = container.querySelector(
      ".settings-toggle-button"
    ) as HTMLButtonElement | null;
    const settingsDropdown = container.querySelector(
      ".settings-dropdown"
    ) as HTMLElement | null;
    if (!settingsButton || !settingsDropdown) return;

    (container as HTMLElement).dataset.initialized = "true";

    // Toggle del dropdown de configuraciones
    settingsButton.addEventListener("click", function (e: MouseEvent) {
      e.preventDefault();
      e.stopPropagation();
      const isHidden = settingsDropdown.classList.contains("hidden");
      if (isHidden) {
        openDropdown(container as HTMLElement);
      } else {
        closeDropdown(container as HTMLElement);
      }
    });

    // Toggle de tema
    const themeToggleButtons = settingsDropdown.querySelectorAll(
      ".theme-toggle-button"
    );
    themeToggleButtons.forEach((button: Element) => {
      (button as HTMLButtonElement).addEventListener(
        "click",
        function (e: MouseEvent) {
          e.preventDefault();
          e.stopPropagation();
          const currentTheme = localStorage.getItem("theme") || "light";
          applyTheme(currentTheme === "dark" ? "light" : "dark");
        }
      );
    });

    // Cerrar al navegar por enlaces dentro del dropdown
    settingsDropdown.querySelectorAll("a[href]").forEach((link: Element) => {
      (link as HTMLAnchorElement).addEventListener("click", function () {
        closeDropdown(container as HTMLElement);
      });
    });
  }

  function initSettingsButtons() {
    document
      .querySelectorAll("[data-settings-root]")
      .forEach((container) => initOne(container as HTMLElement));

    // Añadir manejadores globales una sola vez
    // @ts-ignore
    if (!(window as any).__settingsButtonGlobalHandlersAdded) {
      document.addEventListener("click", function (event: MouseEvent) {
        // Cerrar todos si el clic es fuera de cualquier contenedor
        const target = event.target as HTMLElement | null;
        const insideContainer = target?.closest("[data-settings-root]");
        if (!insideContainer) {
          document
            .querySelectorAll("[data-settings-root]")
            .forEach((c) => closeDropdown(c as HTMLElement));
        }
      });

      document.addEventListener("keydown", function (event: KeyboardEvent) {
        if (event.key === "Escape") {
          document
            .querySelectorAll("[data-settings-root]")
            .forEach((c) => closeDropdown(c as HTMLElement));
        }
      });
      // @ts-ignore
      (window as any).__settingsButtonGlobalHandlersAdded = true;
    }
  }

  // Inicializar
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", initSettingsButtons);
  } else {
    initSettingsButtons();
  }
  document.addEventListener("astro:page-load", initSettingsButtons);
</script>

<style>
  .settings-dropdown {
    transition:
      opacity 0.2s ease-in-out,
      visibility 0.2s ease-in-out,
      transform 0.2s ease-in-out;
    z-index: 50;
  }

  .settings-dropdown.hidden {
    opacity: 0;
    visibility: hidden;
    transform: translateY(-4px) scale(0.95);
  }

  .settings-dropdown:not(.hidden) {
    opacity: 1;
    visibility: visible;
    transform: translateY(0) scale(1);
  }

  .settings-toggle-button:hover {
    transform: rotate(45deg);
  }

  .settings-toggle-button {
    transition: all 0.2s ease-in-out;
  }
</style>
